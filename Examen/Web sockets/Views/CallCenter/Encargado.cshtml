@{ 
    ViewData["Title"] = "Encargado";
}
<div class="row">
    <div class="col-6">
        <h2>Formulario de Encargado</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Apellidos</th>
                    <th>Teléfono</th>
                    <th>Problema</th>
                    <th>Dirección</th>
                    <th>Estado</th>
                    <th>Fecha y Hora de Llegada</th>
                    <th>Fecha y Hora de Atención/Cancelación</th>
                </tr>
            </thead>
            <tbody id="tablaEncargados"></tbody>
        </table>
    </div>
</div>

<script src="~/js/signalr.js"></script>
<script>
    const connectionEncargado = new signalR.HubConnectionBuilder()
        .withUrl("/WebSocketServer")
        .build();

    connectionEncargado.start().then(() => {
        
    }).catch(err => {
        
    });

    connectionEncargado.on("EnviarMensajeTodos", (nombre, apellidos, telefono, problema, direccion) => {
        const nuevaFila = document.createElement("tr");
        nuevaFila.innerHTML = `
            <td>${nombre}</td>
            <td>${apellidos}</td>
            <td>${telefono}</td>
            <td>${problema}</td>
            <td>${direccion}</td>
            <td>Pendiente</td>
            <td>${new Date().toLocaleString()}</td>
            <td></td>
        `;
        document.getElementById("tablaEncargados").appendChild(nuevaFila);
        guardarTablaEnSessionStorage();
        console.log("Información recibida en la vista de encargado:", { nombre, apellidos, telefono, problema, direccion });
    });

    connectionEncargado.on("EstadoActualizado", (estado) => {
        const ultimaFila = document.getElementById("tablaEncargados").lastElementChild;
        if (ultimaFila) {
            ultimaFila.cells[5].textContent = estado;
            ultimaFila.cells[7].textContent = new Date().toLocaleString();
            guardarTablaEnSessionStorage();
        }
    });

    function guardarTablaEnSessionStorage() {
        const filas = Array.from(document.querySelectorAll("#tablaEncargados tr"));
        const registros = filas.map(fila => {
            const columnas = fila.querySelectorAll("td");
            return Array.from(columnas).map(columna => columna.textContent);
        });
        sessionStorage.setItem("tablaEncargados", JSON.stringify(registros));
    }

    function cargarTablaDesdeSessionStorage() {
        const registrosGuardados = sessionStorage.getItem("tablaEncargados");
        if (registrosGuardados) {
            const registros = JSON.parse(registrosGuardados);
            const tabla = document.getElementById("tablaEncargados");
            registros.forEach(registro => {
                const nuevaFila = document.createElement("tr");
                nuevaFila.innerHTML = registro.map(valor => `<td>${valor}</td>`).join("");
                tabla.appendChild(nuevaFila);
            });
        }
    }

    document.addEventListener("DOMContentLoaded", cargarTablaDesdeSessionStorage);
</script>
